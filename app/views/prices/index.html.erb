<%= render :template => '/prices/search_form.html.erb' %>
<style>
th {padding: 10px;}
</style>
<%
if @prices.present?
	xm = Builder::XmlMarkup.new
	uniq_manufacturers = []
	uniq_catalog_numbers = []
	uniq_titles = []
	not_uniq_manufacturers = []
	not_uniq_catalog_numbers = []
	not_uniq_titles = []
	xm.table {
		# Пишем заголовок
		# xm.tr {@header.each {|value| xm.th(value)}}

		# Добавляем столблец - номер по-порядку	
		@header = ['line_number'] + @header
			
		@prices.each_with_index do |line, index|
			
			if line['catalog_number'] == CommonModule::normalize_catalog_number(CommonModule::convert_all_cyr_to_lat(params['catalog_number']))
				uniq_manufacturers << [line['manufacturer'], line['bit_original']]
				uniq_catalog_numbers << line['catalog_number']
				uniq_titles << line['title']
                        end

				not_uniq_manufacturers << [line['manufacturer'], line['bit_original']]
				not_uniq_catalog_numbers << line['catalog_number']
				not_uniq_titles << line['title']
			
			if index % 10 == 0
				xm.tr {@header.each {|value| xm.th(value)}}
			end
			
			xm.tr do
				@header.each do |key|
					if key == 'line_number'
						xm.td(index + 1)
                                        elsif key == "image_url"
                                          xm.td{|str| str << ((line[key]).present? ? "<img src='#{line[key]}'>" : "")}
					elsif key == "retail_cost"
						xm.td(line[key] * AppConfig.prices_discount.to_f)
					elsif key == "catalog_number_orig"
						xm.td{|s| s << link_to(line[key], search_prices_path(:manufacturer => line['manufacturer'], :catalog_number => line['catalog_number'], :replacements => '1', :ext_ws => '1'))}
					else
						xm.td(line[key])
					end
				end
				#line.each {|key, value| xm.td(value)}
			end
		end
	}
	%>

	<%= raw xm.target %>

				<% uniq_manufacturers = uniq_manufacturers.uniq.compact %>
				<p>Названия:<br /><ul><li><%= raw uniq_titles.uniq.compact.join("</li><li>") %></li></ul></p>
				<p>Каталожные номера:<br /><ul><li><%= raw uniq_catalog_numbers.uniq.compact.join('</li><li>') %></li></ul></p>
				<p>
					Производители:
					<ul>
						<li>Оригинальные:<ul><li><%= raw uniq_manufacturers.map{|manufacturer| manufacturer[0] if manufacturer[1] == 1}.compact.join('</li><li>') %></li></ul></li>
						<li>Не оригинальные:<ul><li><%= raw uniq_manufacturers.map{|manufacturer| manufacturer[0] if manufacturer[1] == 0}.compact.join('</li><li>') %></li></ul></li>
					</ul>
				</p>
                                <hr />
				<% not_uniq_manufacturers = not_uniq_manufacturers.uniq.compact %>
				<p>Названия:<br /><ul><li><%= raw not_uniq_titles.uniq.compact.join("</li><li>") %></li></ul></p>
				<p>Каталожные номера:<br /><ul><li><%= raw not_uniq_catalog_numbers.uniq.compact.join('</li><li>') %></li></ul></p>
				<p>
					Производители:
					<ul>
						<li>Оригинальные:<ul><li><%= raw not_uniq_manufacturers.map{|manufacturer| manufacturer[0] if manufacturer[1] == 1}.compact.join('</li><li>') %></li></ul></li>
						<li>Не оригинальные:<ul><li><%= raw not_uniq_manufacturers.map{|manufacturer| manufacturer[0] if manufacturer[1] == 0}.compact.join('</li><li>') %></li></ul></li>
					</ul>
				</p>
<%
end
%>
